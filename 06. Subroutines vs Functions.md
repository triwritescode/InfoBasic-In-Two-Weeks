---
type: concept
tags:
  - Programming
  - InfoBasic
---
## What they are (in one line)

- **SUBROUTINE**: procedure that **does work** and returns **no value**; it **modifies arguments** (pass-by-reference).
- **FUNCTION**: expression that **returns a single value**; best for **pure calculations/formatting**.

---
## Syntax & Calling

```basic
* Subroutine
SUBROUTINE VALIDATE.AMT(AMT, OK, ERRMSG)
   OK = 1 ; ERRMSG = ""
   IF NOT(NUM(AMT)) OR AMT <= 0 THEN OK = 0 ; ERRMSG = "Invalid amount"
RETURN

* Call it
CALL VALIDATE.AMT(AMT, OK, ERR)
IF NOT(OK) THEN CRT ERR

* Function
FUNCTION MONEY.FMT(X)
   X = ROUND(X,2)
   RETURN OCONV(X, "MR2")
END

* Use it inline
CRT "Fee: " : MONEY.FMT(FEE)
```

---
## When to use which

**Use a SUBROUTINE when…**

- You need **multiple outputs** (e.g., `OK`, `ERR`, `WARNINGS`).
- You perform **I/O or locking** (READU/WRITEU/RELEASE).
- You change large MV structures in place.
    
**Use a FUNCTION when…**

- You compute a **single result** (format, convert, calculate).
- It’s **pure** (no side effects) and safe to call inside expressions/enquiries.

---
## Common Patterns

**Validator (multi-output → subroutine)**

```basic
SUBROUTINE VALIDATE.TRANS(REC, OK, ERR)    
	OK = 1 ; ERR = ""    
	IF REC<1> = "" THEN OK = 0 ; ERR = "Missing ID"    
	IF NOT(NUM(REC<10>)) THEN OK = 0 ; ERR<-1> = "Amount not numeric" 
RETURN
```

**Formatter (single output → function)**

```basic
FUNCTION DATE.ISO(D)    
	IF D = 0 THEN RETURN ""    
	RETURN OCONV(D, "D4-") 
END
```

**Safe update wrapper (I/O under lock → subroutine)**

```basic
SUBROUTINE INC.BAL(F.ACC, ID, DELTA, OK, ERR)    
	OK=0 ; ERR=""    
	READU R FROM F.ACC, ID LOCKED ; ERR="Busy" ; RETURN    
	IF NOT(NUM(R<10>)) THEN ERR="Bad balance" ; GOTO DONE    
	R<10> = R<10> + DELTA    
	WRITEU R ON F.ACC, ID    
	OK=1 
DONE:    
	RELEASE F.ACC 
RETURN
```

**Reusable computation (callable inline → function)**

```basic
FUNCTION LATE.FEE(DUE.DATE, TODAY)    
	DAYS = TODAY - DUE.DATE    
	IF DAYS <= 0 THEN RETURN 0    
	RETURN DAYS * 0.5 
END
```

---
## Error & status conventions

- **Subroutine:** return status via an `OK` flag plus `ERR` text (and keep `RELEASE` in all paths).
- **Function:** avoid side effects; if you must signal failure, return a sentinel value (e.g., `''` or `-1`) **and** document it.

---
## Scope & state

- Locals live inside the routine.
- `COMMON` shares state across calls—**avoid** unless you really need it (harder to test, not thread-friendly).
- Prefer passing context (file handles, options) as arguments.

---
## Performance tips

- Put **heavy I/O** and locking in subroutines, not functions used inside tight loops or enquiries.
- Keep functions **pure and cheap** so they’re safe inline.
- For large MV edits, modify **in place** (e.g., `REPLACE REC<…, …> WITH …`) inside a subroutine.

---
# Pitfalls (and fixes)

- **Needing two outputs from a function?** Use a subroutine instead.
- **Forgetting to release a lock** in a subroutine: always have a single `RELEASE` path (label + `GOTO DONE` or guard-clause).
- **Hidden side effects in a function:** can produce surprising results in expressions—keep functions side-effect-free.

---
## Cheatsheet
| Use case                     | Choose         | Why                                    |
| ---------------------------- | -------------- | -------------------------------------- |
| Validate + return OK & ERR   | **SUBROUTINE** | Multiple outputs, side effects allowed |
| Format money/date            | **FUNCTION**   | Single return, pure                    |
| Update record (READU/WRITEU) | **SUBROUTINE** | I/O + locking                          |
| Compute score/amount         | **FUNCTION**   | Inline expression                      |